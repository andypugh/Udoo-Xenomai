***************
*** 823,828 ****
  {
  	struct task_struct *tsk;
  	struct mm_struct * old_mm, *active_mm;
  
  	/* Notify parent that we're no longer interested in the old VM */
  	tsk = current;
--- 823,829 ----
  {
  	struct task_struct *tsk;
  	struct mm_struct * old_mm, *active_mm;
+ 	unsigned long flags;
  
  	/* Notify parent that we're no longer interested in the old VM */
  	tsk = current;
***************
*** 846,857 ****
  	task_lock(tsk);
  	active_mm = tsk->active_mm;
  	tsk->mm = mm;
  	tsk->active_mm = mm;
  	activate_mm(active_mm, mm);
  	if (old_mm && tsk->signal->oom_score_adj == OOM_SCORE_ADJ_MIN) {
  		atomic_dec(&old_mm->oom_disable_count);
  		atomic_inc(&tsk->mm->oom_disable_count);
  	}
  	task_unlock(tsk);
  	arch_pick_mmap_layout(mm);
  	if (old_mm) {
--- 847,860 ----
  	task_lock(tsk);
  	active_mm = tsk->active_mm;
  	tsk->mm = mm;
+ 	ipipe_mm_switch_protect(flags);
  	tsk->active_mm = mm;
  	activate_mm(active_mm, mm);
  	if (old_mm && tsk->signal->oom_score_adj == OOM_SCORE_ADJ_MIN) {
  		atomic_dec(&old_mm->oom_disable_count);
  		atomic_inc(&tsk->mm->oom_disable_count);
  	}
+ 	ipipe_mm_switch_unprotect(flags);
  	task_unlock(tsk);
  	arch_pick_mmap_layout(mm);
  	if (old_mm) {
