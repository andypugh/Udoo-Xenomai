***************
*** 99,105 ****
   * even on CONFIG_PREEMPT, because lockdep assumes that interrupts are
   * not re-enabled during lock-acquire (which the preempt-spin-ops do):
   */
- #if !defined(CONFIG_GENERIC_LOCKBREAK) || defined(CONFIG_DEBUG_LOCK_ALLOC)
  
  static inline unsigned long __raw_spin_lock_irqsave(raw_spinlock_t *lock)
  {
--- 99,107 ----
   * even on CONFIG_PREEMPT, because lockdep assumes that interrupts are
   * not re-enabled during lock-acquire (which the preempt-spin-ops do):
   */
+ #if !defined(CONFIG_GENERIC_LOCKBREAK) ||	\
+ 	defined(CONFIG_DEBUG_LOCK_ALLOC) ||	\
+ 	defined(CONFIG_IPIPE)
  
  static inline unsigned long __raw_spin_lock_irqsave(raw_spinlock_t *lock)
  {
***************
*** 113,119 ****
  	 * do_raw_spin_lock_flags() code, because lockdep assumes
  	 * that interrupts are not re-enabled during lock-acquire:
  	 */
- #ifdef CONFIG_LOCKDEP
  	LOCK_CONTENDED(lock, do_raw_spin_trylock, do_raw_spin_lock);
  #else
  	do_raw_spin_lock_flags(lock, &flags);
--- 115,121 ----
  	 * do_raw_spin_lock_flags() code, because lockdep assumes
  	 * that interrupts are not re-enabled during lock-acquire:
  	 */
+ #if defined(CONFIG_LOCKDEP) || defined(CONFIG_IPIPE)
  	LOCK_CONTENDED(lock, do_raw_spin_trylock, do_raw_spin_lock);
  #else
  	do_raw_spin_lock_flags(lock, &flags);
