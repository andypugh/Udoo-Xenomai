***************
*** 67,72 ****
  
  #define __get_cpu_var(var) (*this_cpu_ptr(&(var)))
  #define __raw_get_cpu_var(var) (*__this_cpu_ptr(&(var)))
  
  #ifdef CONFIG_HAVE_SETUP_PER_CPU_AREA
  extern void setup_per_cpu_areas(void);
--- 67,86 ----
  
  #define __get_cpu_var(var) (*this_cpu_ptr(&(var)))
  #define __raw_get_cpu_var(var) (*__this_cpu_ptr(&(var)))
+ #ifdef CONFIG_IPIPE
+ #if defined(CONFIG_IPIPE_DEBUG_INTERNAL) && defined(CONFIG_SMP)
+ extern int __ipipe_check_percpu_access(void);
+ #define __ipipe_local_cpu_offset				\
+ 	({							\
+ 		WARN_ON_ONCE(__ipipe_check_percpu_access());	\
+ 		__my_cpu_offset;				\
+ 	})
+ #else
+ #define __ipipe_local_cpu_offset  __my_cpu_offset
+ #endif
+ #define __ipipe_get_cpu_var(var) \
+ 	(*SHIFT_PERCPU_PTR(&(var), __ipipe_local_cpu_offset))
+ #endif /* CONFIG_IPIPE */
  
  #ifdef CONFIG_HAVE_SETUP_PER_CPU_AREA
  extern void setup_per_cpu_areas(void);
***************
*** 82,87 ****
  #define per_cpu(var, cpu)	(*((void)(cpu), VERIFY_PERCPU_PTR(&(var))))
  #define __get_cpu_var(var)	(*VERIFY_PERCPU_PTR(&(var)))
  #define __raw_get_cpu_var(var)	(*VERIFY_PERCPU_PTR(&(var)))
  #define this_cpu_ptr(ptr)	per_cpu_ptr(ptr, 0)
  #define __this_cpu_ptr(ptr)	this_cpu_ptr(ptr)
  
--- 96,102 ----
  #define per_cpu(var, cpu)	(*((void)(cpu), VERIFY_PERCPU_PTR(&(var))))
  #define __get_cpu_var(var)	(*VERIFY_PERCPU_PTR(&(var)))
  #define __raw_get_cpu_var(var)	(*VERIFY_PERCPU_PTR(&(var)))
+ #define __ipipe_get_cpu_var(var) __raw_get_cpu_var(var)
  #define this_cpu_ptr(ptr)	per_cpu_ptr(ptr, 0)
  #define __this_cpu_ptr(ptr)	this_cpu_ptr(ptr)
  
