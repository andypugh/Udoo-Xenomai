***************
*** 155,160 ****
  	smp_call_function(do_nothing, NULL, 1);
  }
  EXPORT_SYMBOL_GPL(cpu_idle_wait);
  
  /*
   * This is our default idle handler.  We need to disable
--- 155,185 ----
  	smp_call_function(do_nothing, NULL, 1);
  }
  EXPORT_SYMBOL_GPL(cpu_idle_wait);
+ #ifdef CONFIG_IPIPE
+ static void __ipipe_halt_root(void)
+ {
+ 	struct ipipe_percpu_domain_data *p;
+ 
+ 	/* Emulate idle entry sequence over the root domain. */
+ 
+ 	local_irq_disable_hw();
+ 
+ 	p = ipipe_root_cpudom_ptr();
+ 
+ 	trace_hardirqs_on();
+ 	clear_bit(IPIPE_STALL_FLAG, &p->status);
+ 
+ 	if (unlikely(__ipipe_ipending_p(p))) {
+ 		__ipipe_sync_pipeline();
+ 		local_irq_enable_hw();
+ 	} else {
+ 		local_irq_enable_hw();
+ 		arch_idle();
+ 	}
+ }
+ #else /* !CONFIG_IPIPE */
+ #define __ipipe_halt_root() arch_idle()
+ #endif /* !CONFIG_IPIPE */
  
  /*
   * This is our default idle handler.  We need to disable
***************
*** 163,169 ****
  static void default_idle(void)
  {
  	if (!need_resched())
- 		arch_idle();
  	local_irq_enable();
  }
  
--- 188,194 ----
  static void default_idle(void)
  {
  	if (!need_resched())
+ 		__ipipe_halt_root();
  	local_irq_enable();
  }
  
